name: STM32 Linux CI
run-name: ${{github.actor}} Is Testing Github Action
on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install gcc-arm-none-eabi binutils-arm-none-eabi cmake ninja-build 
        sudo apt-get install -y cppcheck clang-tidy
        
    - name: Verify installations
      run: |
        arm-none-eabi-gcc --version
        cmake --version
        ninja --version  
    
    - name: Configure Project
      run: |
        cmake -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=cmake/cortex_m3.cmake \
            -DENABLE_STATIC_ANALYSIS=ON \
            -DENABLE_REGRESSION_TEST=ON \
            -DENABLE_UNIT_TEST=ON \
            -DENABLE_COVERAGE=OFF

    - name: 代码质量检查
      run: |
        cmake --build build --target static-analysis

    - name: 构建项目
      run: |
        #cmake --build build --target all --parallel
        cmake --build build --parallel

    - name: 回归测试
      run: |
        # 方案1：如果已有测试程序
        if [ -f "build/test_runner" ]; then
            ./build/test_runner
        fi
        
        # 方案2：使用脚本运行测试
        if [ -f "scripts/run_tests.sh" ]; then
            chmod +x scripts/run_tests.sh
            ./scripts/run_tests.sh
        fi
        
        # 方案3：简单验证构建结果
        echo "回归测试：验证固件生成"
        ls -la build/*.bin && echo "构建成功" || exit 1
        
    - name: 单元测试
      run: |
        cd build
        # 先列出可用的测试
        ctest -N
        # 运行测试并生成报告
        ctest --output-on-failure --output-junit test-results.xml
        # 检查生成的文件
        ls -la test-results.xml
        echo "文件内容:"
        cat test-results.xml || echo "文件为空或格式错误"
    
    - name: 上传bin文件
      uses: actions/upload-artifact@v4
      with:
        name: firmware-artifacts
        path: build/*.bin
        retention-days: 7
        
    - name: 上传测试报告
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          build/test-results.xml
          build/DEMO.bin
          build/DEMO.elf
          build/Testing/Temporary/LastTest.log
        retention-days: 7
        
    - name: 调试-查看生成的文件结构
      run: |
        echo "=== 查看build目录结构 ==="
        find build/ -name "*.xml" -o -name "*.html" -o -name "*.log" | head -20
        echo "=== 查看Testing目录内容 ==="
        ls -la build/Testing/ 2>/dev/null || echo "Testing目录不存在"
        echo "=== 查看整个build目录 ==="
        ls -la build/
