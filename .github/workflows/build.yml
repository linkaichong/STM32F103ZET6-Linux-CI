name: STM32 Linux CI
run-name: ${{github.actor}} Is Testing Github Action
on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install gcc-arm-none-eabi binutils-arm-none-eabi cmake ninja-build 
        sudo apt-get install -y cppcheck clang-tidy
        
    - name: Verify installations
      run: |
        arm-none-eabi-gcc --version
        cmake --version
        ninja --version  
    
    - name: Configure Project
      run: |
        cmake -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=cmake/cortex_m3.cmake \
            -DENABLE_REGRESSION_TEST=ON \
            -DENABLE_UNIT_TEST=ON \
            -DENABLE_COVERAGE=OFF

    - name: 直接运行静态代码分析
      run: |
        echo "=== 运行cppcheck ==="
        cppcheck --enable=warning,performance,portability \
                 --suppress=missingIncludeSystem \
                 --inline-suppr \
                 --quiet \
                 src/ 2> cppcheck_results.txt || true
        
        echo "=== 运行clang-tidy ==="
        # 先构建项目生成compile_commands.json
        cmake --build build --parallel
        
        if [ -f "build/compile_commands.json" ]; then
            find src/ -name "*.c" -exec clang-tidy -p build {} \; 2> clang_tidy_results.txt || true
        else
            echo "compile_commands.json不存在，跳过clang-tidy"
        fi
        
        # 显示分析结果摘要
        echo "=== 静态分析结果 ==="
        if [ -s "cppcheck_results.txt" ]; then
            echo "cppcheck发现的问题:"
            cat cppcheck_results.txt
        else
            echo "cppcheck: 未发现问题"
        fi
        
        if [ -s "clang_tidy_results.txt" ]; then
            echo "clang-tidy发现的问题:"
            cat clang_tidy_results.txt
        else
            echo "clang-tidy: 未发现问题"
        fi

    - name: 构建项目
      run: |
        cmake --build build --parallel

    - name: 回归测试
      run: |
        echo "回归测试：验证固件生成"
        ls -la build/*.bin && echo "构建成功" || exit 1
        
    - name: 单元测试
      run: |
        cd build
        ctest --output-on-failure --output-junit test-results.xml || echo "测试完成"
    
    - name: 上传bin文件
      uses: actions/upload-artifact@v4
      with:
        name: firmware-artifacts
        path: build/*.bin
        retention-days: 7
        
    - name: 上传测试报告和分析结果
      uses: actions/upload-artifact@v4
      with:
        name: analysis-reports
        path: |
          build/test-results.xml
          cppcheck_results.txt
          clang_tidy_results.txt
        retention-days: 7
